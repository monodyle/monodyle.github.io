{"pageProps":{"post":{"title":"Mấy cái trò Database Hacking","date":"Mar 15, 2020","slug":"sql-database-hacking","content":"<p>Hôm nọ mình vừa đọc được một bài write-up của một bạn white-hat sau khi báo cáo lại lỗ hổng SQL Injection trên trang web của Đại học Harvard, tự dưng thấy kỹ năng về bảo mật của mình bao lâu nay... kém ghê.</p>\n<p>Bản thân là sinh viên chuyên ngành <strong>Hệ Thống Thông Tin</strong>, tức là chuyên ngồi đấu vật với mấy cái cơ sở dữ liệu mà lại rất hay quên đi những cái quan trọng như thế này... Cảm thấy xấu hổ, thế là mình phải mò lại những gì mình đã học, nhưng không dùng tới lại quên mất, rồi viết thành một blog để coi như vừa học lại, vừa chia sẻ kiến thức cho mọi người <img src=\"/assets/emoji/smug.png\" emoji /> <del>Mình thật tuyệt</del></p>\n<h2 id=\"thằng-chó-mày-hack-web-bố-mày\">Thằng chó, mày hack web bố mày...</h2>\n<p>Hè vừa rồi mình có trò chuyện với một ông anh trong nghề, ổng tâm sự về chuyện bị thằng nào thả bot nó clean mẹ cái database, để lại đúng một dòng duy nhất:</p>\n<blockquote>\n<p>Gửi bố mày vài Bitcoin đê, bố mày trả lại dữ liệu cho... <img src=\"/assets/emoji/look_down.png\" emoji /></p>\n</blockquote>\n<p>Và kèm theo đó là địa chỉ ví bitcoin của hắn <img src=\"/assets/emoji/surrender.png\" emoji /> Tính ông anh mình được cái thật thà, nhà cũng không có gì ngoài điều kiện, thế là gửi cho nó vài bitcoin coi như tiền ăn sáng, hôm sau thấy nó restore lại dữ liệu thật <img src=\"/assets/emoji/mokas.png\" emoji /></p>\n<p>Nhưng mà tức quá, ai đời làm lập trình có sản phẩm đang chạy phà phà lại có thằng choá nào hack, nghĩ có cay không cơ chứ? <img src=\"/assets/emoji/yikes.png\" emoji /></p>\n<p>Mình không rõ là cái database đó bị hack như thế nào, nhưng khá chắc chắn phần lớn là bởi vì code chưa đủ bảo mật và có nhiều lỗ hổng. Các hacker sẽ viết một con bot chuyên đi dạo trên mạng để attack vào những case bảo mật thường dễ bị hack nhất.</p>\n<p>Vì vậy bài viết này mình sẽ giới thiệu cho các bạn một loại lỗ hổng <strong>cơ bản</strong> nhưng cực kỳ nguy hiểm, giải thích cơ chế và hướng dẫn cách phòng chống. Và xin giới thiệu cái trò gọi là <strong>SQL Injection</strong>.</p>\n<p><strong>Lưu ý:</strong></p>\n<p>Bài viết này nhằm mục đích giao lưu kỹ năng bảo mật lập trình, không cổ suý các bạn đi phá làng phá xóm. Hãy tỉnh táo <img src=\"/assets/emoji/smug.png\" emoji /></p>\n<h2 id=\"nhập-môn-hack-cơ-sở-dữ-liệu-sql\">Nhập môn hack Cơ sở dữ liệu SQL</h2>\n<p>Trong nhiều loại tấn công lỗ hổng nhằm vào website, tấn công <strong>SQL Injection</strong> là một trong những loại nguy hiểm và phổ biến nhất. Nó đã từng gây ra nhiều thiệt hại đáng kể cho nhiều doanh nghiệp và tổ chức trong rất nhiều năm, và đương nhiên sẽ còn tiếp diễn trong tương lai.</p>\n<p></p>\n<p>Theo <a href=\"https://vi.wikipedia.org/wiki/SQL_injection\">Wikipedia</a> <img src=\"/assets/emoji/popcorn.png\" emoji />:</p>\n<blockquote>\n<p><strong>SQL injection</strong> là một kỹ thuật cho phép những kẻ tấn công lợi dụng lỗ hổng của việc kiểm tra dữ liệu đầu vào trong các ứng dụng web và các thông báo lỗi của hệ quản trị cơ sở dữ liệu trả về để <em>inject</em> (<em>tiêm vào</em>) và thi hành các câu lệnh SQL bất hợp pháp.</p>\n</blockquote>\n<p>Ờ thì khái niệm như vậy đấy, hiểu một cách đơn giản tức là loại tấn công này nhằm vào các <strong>input</strong> có <strong>tương tác trực tiếp</strong> với <strong>database</strong> ở <strong>back-end</strong> (ví dụ như các input email, password ở form login). Thông thường, attacker sẽ tấn công để ăn cắp dữ liệu, loại này về cơ bản là hiền nhất, sau đó tới xáo trộn dữ liệu để cản trở sự hoạt động của website, và trường hợp xấu nhất, là quyền truy cập quản trị vào máy chủ database bị chiếm. <img src=\"/assets/emoji/moka.png\" emoji /></p>\n<p>Trong lịch sử, đã có rất nhiều đợt tấn công SQL Injection nhằm mục đích:</p>\n<ul>\n<li>Trích xuất thông tin nhạy cảm, ví dụ như về an sinh xã hội, hay thông tin thẻ tín dụng</li>\n<li>Trích xuất thông tin người dùng đã được đăng ký trên các website, ở Việt Nam cũng không ít trường hợp</li>\n<li>Xoá luôn cái database, có rất nhiều trang web không sử dụng backup dữ liệu, và khi bị xoá thì coi như cả hệ thống tê liệt, ví dụ của ông anh bên trên là ví dụ gần gũi nhất</li>\n<li>Tiêm mã độc thực thi vào trang web khi người dùng truy cập</li>\n</ul>\n<p><strong>Nhắc lại một lần nữa:</strong> Tấn công về SQL Injection cực kỳ phổ biến. Các công ty lớn như <strong>Yahoo</strong> hay <strong>Sony</strong> đã từng là nhạn nhân của trò chơi này. Các nhóm hacker còn viết hẳn các script bot để tự đi tấn công dạo trên internet, vì vậy hãy luôn cẩn thận với sản phẩm của bạn.</p>\n<h3 id=\"cơ-chế-khai-thác-và-tấn-công\">Cơ chế khai thác và tấn công</h3>\n<p>SQL Injection tấn công bằng cách gửi một mã lệnh SQL độc đến back-end của máy chủ cơ sở đữ liệu, thông qua các request của người dùng mà website cho phép. Bất kỳ input nào cũng có thể được sử dụng để gửi mã độc, tức là bao gồm cả: các thẻ <code>&#x3C;input></code> nhập liệu, query strings, cookies và file upload.</p>\n<p>Mình sẽ có một ví dụ như sau: Giả sử đây là trang đăng nhập vào ngân hàng <strong>PankHub</strong>, với form đăng nhập gồm 2 fields là <code>email</code> và <code>password</code>:</p>\n<p>Bây giờ mình sẽ thử đăng nhập tài khoản của người dùng tên là <strong>Phát</strong> (jk, don't panic) với <em>email</em> là: <code>phat.nhagiau@pankhub.com</code> và <em>password</em> là <code>password</code></p>\n<p>Ừ thì đương nhiên là không đăng nhập được rồi <img src=\"/assets/emoji/okay.png\" emoji /> Đây là trường hợp giả sử mình là một attacker, và mình tình cờ địa được email của người dùng này sau khi đi ngang qua lúc nó đang đăng nhập vào ngân hàng ở tiệm net <img src=\"/assets/emoji/smug.png\" emoji /> Victim của mình là một thằng đại gia nhà giàu, tiền không những được quy ra bằng vàng để trong két mà còn có cả một đống trong nhà băng. Xác định được mục tiêu thì trích xuất thông tin mục tiêu là điều cần thiết. Vì vậy mình chỉ thử đăng nhập cho vui thôi, đương nhiên làm gì có thằng <del>ngu</del> nào đặt mật khẩu là <code>password</code> cơ chứ (jk)</p>\n<p>Bây giờ hãy nhìn vấn đề từ phía server log nhé, chúng ta sẽ có 1 cái logging như sau:</p>\n<pre><code>Rendering login page.\nChecking supplied authentication details for phat.nhagiau@pankhub.com.\nFinding user in database.\nNo such user, report this to the user (invalid credentials?).\nRendering login page.\n</code></pre>\n<p>Sau đó, mình tiếp tục truy thử login vào tài khoản của victim, nhưng lần này password mình sẽ thêm một <em>dấu nháy đơn</em> <code>'</code>, kết quả có được là:</p>\n<p>Thấy sự khác biệt rồi phải không? Thông thường, với những trường hợp sai thông tin đăng nhập sẽ luôn cho ra một message lỗi (trang nào nó random message thì bó tay), vì vậy có gì đó không đúng xảy ra rồi, có thể nguyên do là bởi dấu nháy đơn chăng?</p>\n<p>Server log:</p>\n<pre><code>...\n\nRendering login page.\nChecking supplied authentication details for phat.nhagiau@pankhub.com.\nFinding user in database.\nAn error occurred: PG::SyntaxError: ERROR: unterminated quoted string at or near \"'password'' limit 1\" LINE 1: ...ers where email = 'phat.nhagiau@pankhub.com' and password = 'password'... ^ : select * from users where email = 'phat.nhagiau@pankhub.com' and password = 'password'' limit 1.\nUnable to login this user due to unexpected error.\nRendering login page.\n</code></pre>\n<p>Nhìn thấy ở log hiển thị SQL syntax error chứ? Điều này chứng tỏ dấu nháy đơn chính là nguyên nhân gây ra lỗi. Thử ghép vào câu lệnh SQL được chạy trên server thì nó sẽ trông như thế này:</p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #D73A49\">SELECT</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">*</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">FROM</span><span style=\"color: #24292E\"> users</span></span>\n<span class=\"line\"><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">WHERE</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'phat.nhagiau@pankhub.com'</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">   </span><span style=\"color: #D73A49\">AND</span><span style=\"color: #24292E\"> pass  </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'password'' LIMIT 1</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Dư 1 dấu nháy đơn, câu lệnh này chạy trong SQL chắc chắn sẽ lỗi. Và đây chính là thứ gọi là <strong>SQL Injection</strong>.</p>\n<p>Sau khi xác định được lỗ hổng, mình sẽ thử đăng nhập lại với password là <strong><code>' OR 1=1--</code></strong>. Câu lệnh SQL lúc này được thực thi trên server sẽ là:</p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #D73A49\">SELECT</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">*</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">FROM</span><span style=\"color: #24292E\"> users</span></span>\n<span class=\"line\"><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">WHERE</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'phat.nhagiau@pankhub.com'</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">   </span><span style=\"color: #D73A49\">AND</span><span style=\"color: #24292E\"> pass  </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">''</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">OR</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">1</span><span style=\"color: #D73A49\">=</span><span style=\"color: #005CC5\">1</span><span style=\"color: #24292E\"> </span><span style=\"color: #6A737D\">--' LIMIT 1</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Server log:</p>\n<pre><code>Rendering login page.\nChecking supplied authentication details for phat.nhagiau@pankhub.com.\nFinding user in database.\nAuthentication details confirmed, establishing session for this user.\n</code></pre>\n<p>Xong, tài khoản của bạn nằm trong tay tôi <img src=\"/assets/emoji/ok.png\" emoji /></p>\n<p>Cơ chế hoạt động đơn giản nhất của <strong>SQL Injection</strong> là như vậy đọ. Thực thi nó không hề khó, nhưng để nhận ra được trang nào có lỗ hổng thì lại khá khó, vì không phải lúc nào khai thác lỗ hổng SQL Injection nó cũng y chang như vậy.</p>\n<h3 id=\"nhưng-tại-sao-có-lỗ-hổng-này\">Nhưng tại sao có lỗ hổng này?</h3>\n<p>Lý do lớn nhất là các bạn chưa thể tiếp cận toàn bộ các case trong quá trình code. Bạn không bao giờ lường trước được người dùng sẽ làm cái <del>đéo</del> gì trên sản phẩm của mình. <img src=\"/assets/emoji/sad.png\" emoji /> Chính vì vậy thường các case không bao giờ được nghĩ tới này lại vô tình tạo ra lỗ hổng cho attacker khai thác.</p>\n<p>Khi viết các câu lệnh SQL trong source (ở đây mình sẽ lấy <strong>PHP</strong> làm ví dụ), đa số các bạn thường viết kiểu:</p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #24292E\">$query </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">\"</span><span style=\"color: #D73A49\">SELECT</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">FROM</span><span style=\"color: #24292E\"> USERS</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">WHERE</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'\"</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">.</span><span style=\"color: #24292E\"> $_POST[</span><span style=\"color: #032F62\">'email'</span><span style=\"color: #24292E\">] </span><span style=\"color: #D73A49\">.</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">\"'</span></span>\n<span class=\"line\"><span style=\"color: #032F62\">  AND password = '\"</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">.</span><span style=\"color: #24292E\"> $_POST[</span><span style=\"color: #032F62\">'password'</span><span style=\"color: #24292E\">] </span><span style=\"color: #D73A49\">.</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">\"'</span></span>\n<span class=\"line\"><span style=\"color: #032F62\">  LIMIT 1;\"</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$result </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> $connection</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">query</span><span style=\"color: #24292E\">($sql);</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Khi người dùng gửi request đăng nhập có thông tin, thì câu query trên sẽ tương đương với:</p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #D73A49\">SELECT</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">*</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">FROM</span><span style=\"color: #24292E\"> USERS</span></span>\n<span class=\"line\"><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">WHERE</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'phat.nhagiau@pankhub.com'</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">   </span><span style=\"color: #D73A49\">AND</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">password</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">'password'</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">LIMIT</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">1</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Tức là cái gì gửi lên, thì param tương đương sẽ được thay thế bằng cái đó. Điều này vô tình tạo ra một lỗ hổng cực kỳ nguy hiểm. Nếu bạn từng học các môn liên quan tới database hoặc làm việc với database nhiều, các bạn có thể hiểu rằng chỉ với những câu lệnh SQL thôi cũng đủ để chúng làm bất cứ thứ gì liên quan tới dữ liệu.</p>\n<p>Không những thế, SQL Injection còn có thể thực thi được mã HTML hoặc PHP trong nhiều trường hợp. Đó là lý do tại sao lỗ hổng này nghiêm trọng như vậy.</p>\n<h3 id=\"chống-injection-như-thế-nào\">Chống injection như thế nào?</h3>\n<h4 id=\"truy-vấn-tham-số-parameterized-statements\">Truy vấn tham số (Parameterized Statements)</h4>\n<p>Đa số các ngôn ngữ lập trình hỗ trợ truy vấn SQL đều sẽ hỗ trợ chạy các câu lệnh SQL bằng cách tạo truy vấn để trích xuất các tham số khi cần thiết. Các câu lệnh nên được <em>tham số hoá</em> để đảm bảo rằng các <em>tham số</em> (tức là <em>dữ liệu đầu vào</em>) đưa vào câu lệnh SQL được xử lý một cách an toàn nhất.</p>\n<p>Với ví dụ ở <a href=\"#nh%c6%b0ng-t%e1%ba%a1i-sao-c%c3%b3-l%e1%bb%97-h%e1%bb%95ng-n%c3%a0y\">phần trên</a>, chúng ta sẽ thử đưa nó về dạng truy vấn tham số:</p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #6A737D\">// Câu lệnh SQL chờ tham số</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$sql </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">\"</span><span style=\"color: #D73A49\">SELECT</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">FROM</span><span style=\"color: #24292E\"> USERS</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">WHERE</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> ?</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">AND</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">password</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> ?</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">LIMIT</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">1</span><span style=\"color: #032F62\">\"</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\">// Chuẩn bị và ràng buộc</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> $connection</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">prepare</span><span style=\"color: #24292E\">($sql);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">bind_param</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">\"ss\"</span><span style=\"color: #24292E\">, $email, $password);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\">// Truyền tham số và thực thi</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> $_POST[</span><span style=\"color: #032F62\">'email'</span><span style=\"color: #24292E\">];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$password </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> $_POST[</span><span style=\"color: #032F62\">'password'</span><span style=\"color: #24292E\">];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">execute</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\">// Đừng quên close connection mỗi lần thực thi xong</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">close</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$conn</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">close</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Dạng <strong>bind</strong> param này chắc có lẽ sẽ khó để truyền tham số khi số lượng column cần dùng trong query trở nên nhiều hơn, vậy nên còn có cách như sau:</p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #6A737D\">// Câu lệnh SQL chờ tham số</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$sql </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #032F62\">\"</span><span style=\"color: #D73A49\">SELECT</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">*</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">FROM</span><span style=\"color: #24292E\"> USERS</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">WHERE</span><span style=\"color: #24292E\"> email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> :email</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">AND</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">password</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> :</span><span style=\"color: #D73A49\">password</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">LIMIT</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">1</span><span style=\"color: #032F62\">\"</span><span style=\"color: #24292E\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\">// Chuẩn bị và ràng buộc</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> $connection</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">prepare</span><span style=\"color: #24292E\">($sql);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">bindParam</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">\":email\"</span><span style=\"color: #24292E\">, $email);</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">bindParam</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">\":password\"</span><span style=\"color: #24292E\">, $password);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\">// Truyền tham số và thực thi</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$email </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> $_POST[</span><span style=\"color: #032F62\">'email'</span><span style=\"color: #24292E\">];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$password </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> $_POST[</span><span style=\"color: #032F62\">'password'</span><span style=\"color: #24292E\">];</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">$stmt</span><span style=\"color: #D73A49\">-></span><span style=\"color: #6F42C1\">execute</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"></span></code></pre>\n<p>Ví dụ trong một số ngôn ngữ khác:</p>\n<p><strong>C#</strong></p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #6A737D\">// Create the SQL command.</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">SqlCommand</span><span style=\"color: #24292E\"> </span><span style=\"color: #6F42C1\">command</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">SqlCommand</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">\"select * from users where email = @email\"</span><span style=\"color: #24292E\">, conn);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\">// Add the parameter values in separately.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">command.Parameters.</span><span style=\"color: #6F42C1\">Add</span><span style=\"color: #24292E\">(</span><span style=\"color: #D73A49\">new</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">SqlParameter</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">\"email\"</span><span style=\"color: #24292E\">, email);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6F42C1\">using</span><span style=\"color: #24292E\"> (SqlDataReader reader </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> command.</span><span style=\"color: #6F42C1\">ExecuteReader</span><span style=\"color: #24292E\">())</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">{</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #6F42C1\">while</span><span style=\"color: #24292E\"> (reader.</span><span style=\"color: #6F42C1\">Read</span><span style=\"color: #24292E\">())</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #6A737D\">// Do something with the retrieved data.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">}</span></span>\n<span class=\"line\"></span></code></pre>\n<p><strong>Django</strong></p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #6A737D\"># Good</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">Users.objects.filter(</span><span style=\"color: #E36209\">email</span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\">email)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\"># Good</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">Users.objects.raw(</span><span style=\"color: #032F62\">\"select * from users where email = </span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\">\"</span><span style=\"color: #24292E\">, [email])</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\"># Liable to got hacked</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">Users.objects.raw(</span><span style=\"color: #032F62\">\"select * from users where email = '</span><span style=\"color: #005CC5\">%s</span><span style=\"color: #032F62\">'\"</span><span style=\"color: #24292E\"> </span><span style=\"color: #D73A49\">%</span><span style=\"color: #24292E\"> email)</span></span>\n<span class=\"line\"></span></code></pre>\n<p><strong>Node</strong></p>\n<pre class=\"shiki\" style=\"background-color: #fff\"><code><span class=\"line\"><span style=\"color: #6A737D\">// node-sql</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">var</span><span style=\"color: #24292E\"> sql </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">require</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">'sql'</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">var</span><span style=\"color: #24292E\"> query </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> user.</span><span style=\"color: #6F42C1\">select</span><span style=\"color: #24292E\">(user.</span><span style=\"color: #6F42C1\">star</span><span style=\"color: #24292E\">()))</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                .</span><span style=\"color: #6F42C1\">from</span><span style=\"color: #24292E\">(user)</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">                .</span><span style=\"color: #6F42C1\">where</span><span style=\"color: #24292E\">(user.email.</span><span style=\"color: #6F42C1\">equals</span><span style=\"color: #24292E\">(email)).</span><span style=\"color: #6F42C1\">toQuery</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #6A737D\">// mysql</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">var</span><span style=\"color: #24292E\"> mysql </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> </span><span style=\"color: #005CC5\">require</span><span style=\"color: #24292E\">(</span><span style=\"color: #032F62\">'mysql'</span><span style=\"color: #24292E\">);</span></span>\n<span class=\"line\"><span style=\"color: #D73A49\">var</span><span style=\"color: #24292E\"> connection </span><span style=\"color: #D73A49\">=</span><span style=\"color: #24292E\"> mysql.</span><span style=\"color: #6F42C1\">createConnection</span><span style=\"color: #24292E\">({ host: </span><span style=\"color: #005CC5\">HOST</span><span style=\"color: #24292E\">, user: </span><span style=\"color: #005CC5\">USERNAME</span><span style=\"color: #24292E\">, password: </span><span style=\"color: #005CC5\">PASSWORD</span><span style=\"color: #24292E\"> });</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">connection.</span><span style=\"color: #6F42C1\">connect</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">connection.</span><span style=\"color: #6F42C1\">query</span><span style=\"color: #24292E\">(</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #032F62\">'select * from users where email = ?'</span><span style=\"color: #24292E\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  [email],</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  </span><span style=\"color: #D73A49\">function</span><span style=\"color: #24292E\">(</span><span style=\"color: #E36209\">err</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">rows</span><span style=\"color: #24292E\">, </span><span style=\"color: #E36209\">fields</span><span style=\"color: #24292E\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">    </span><span style=\"color: #6A737D\">// Do something with the retrieved data.</span></span>\n<span class=\"line\"><span style=\"color: #24292E\">  });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292E\">connection.</span><span style=\"color: #6F42C1\">end</span><span style=\"color: #24292E\">();</span></span>\n<span class=\"line\"></span></code></pre>\n<h4 id=\"hãy-validation-từ-front-end-cho-tới-back-end\">Hãy validation từ Front-end cho tới Back-end</h4>\n<p><strong>Validation</strong> dữ liệu chưa bao giờ là công việc thú vị <img src=\"/assets/emoji/okay.png\" emoji /> tuy nhiên việc validation 2 bước giúp bảo mật tốt hơn, và đồng thời cũng tránh được các lỗi lặt vặt không cần thiết.</p>\n<p>Ví dụ trên front-end các field nhập vào dữ liệu số, nên dùng input <code>number</code> thay vì input <code>text</code>. Các field bắt buộc thì nên <code>required</code>. Mặc dù trên front-end có thể verify dữ liệu đầu vào, nhưng attacker vẫn có thể ignore những rule này để trực tiếp gửi dữ liệu vào back-end, vậy nên trên back-end chúng ta nên verify lại dữ liệu, như kiểu <code>$age = (int)$_POST['age']</code>. Điều này sẽ tránh được các yếu tố gây ra lỗi không đáng có.</p>\n<h4 id=\"phân-quyền-quản-trị\">Phân quyền quản trị</h4>\n<p>Mình thấy rất nhiều bạn khi xây dựng project, thường sử dụng tài khoản <strong><code>root</code></strong> của DBMS để làm tất cả mọi thứ... Đó là một sai lầm cực kỳ lớn. Phần lớn các bạn đều chưa hiểu mức độ nghiêm trọng của vấn đề này, vấn đề này giải thích cũng khó hiểu, phải trong trường hợp thực tế các bạn học được thì dễ nhớ hơn.</p>\n<p>Tuy nhiên mình vẫn sẽ đưa ra một ví dụ đơn giản như sau:</p>\n<p>Khi bạn đăng nhập, việc cần làm của database chỉ là vào đọc dữ liệu (quyền <strong>READ</strong>) để verify thông tin. Trong khi các bạn lại cấp full quyền cho <strong>user</strong> của DBMS chỉ dùng để đọc... Giả sử form đăng nhập trên hệ thống có lỗ hổng SQL Injection, thì việc attack từ cái form login xoá toàn bộ dữ liệu của bạn là điều cực kỳ đơn giản, còn nếu user tương tác với database chỉ có quyền đọc, thì attacker cũng chỉ có thể truy cập tài khoản đó mà thôi.</p>\n<p>Nghĩa là bạn chỉ gặp một nguy cơ nhỏ hơn so với cái nguy cơ cực kỳ khủng khiếp kia.</p>\n<p>Đó, không phải tự dưng mà <strong>Oracle</strong> được cho là hệ quản trị database SQL bảo mật nhất, lý do là vì phân quyền của <strong>Oracle</strong> cực kỳ chặt chẽ. Do đó, tốt nhất nên phân quyền cho các user trong DBMS một cách chặt chẽ và hợp lý, để tránh hối hận về lâu về dài.</p>\n<p>Vấn đề phân quyền không phải chỉ ở trong DBMS, mà còn ở trong cả hệ thống, và cấu hình <strong>server</strong>. Nhắc lại lần nữa: <strong>Phân quyền cực kỳ quan trọng</strong></p>\n<p></p>\n<h2 id=\"kết-luận\">Kết luận</h2>\n<p>SQL Injection không phải một vấn đề mới mẻ, nó tồn tại cả một thập kỷ rồi nhưng nó vẫn đứng đầu bảng xếp hạng về các lỗ hổng nguy hiểm nhất trong nhiều năm liền. Chỉ với một vài bước dễ dàng, hệ thống của bạn có thể bị tê liệt hoàn toàn... Chống thì khó, mà phá thì dễ lắm.</p>\n<p>Nên nhớ:</p>\n<blockquote>\n<p>Đạo cao một thước, ma cao một trượng.</p>\n</blockquote>","image":"/assets/blog/sql-database-hacking/featured.jpg","tags":["web","database","hacking","security"]}},"__N_SSG":true}