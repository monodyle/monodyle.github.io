<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#24292e"/><meta name="apple-mobile-web-app-title" content="The Monody\&#x27;s Blog"/><meta name="application-name" content="The Monody\&#x27;s Blog"/><meta name="msapplication-TileColor" content="#1366E9"/><meta name="theme-color" content="#ffffff"/><title>Mấy cái trò Database Hacking</title><meta name="title" content="Mấy cái trò Database Hacking"/><meta name="description" content="Hôm nọ mình vừa đọc được một bài write-up của một bạn White-hat sau khi báo cáo lại lỗ hổng trên trang web của Đại học Harvard, tự dưng thấy kỹ năng về bảo mật của mình bao lâu nay... kém ghê"/><meta name="image" content="https://monodyle.github.io/blog/sql-database-hacking/featured.jpg"/><meta property="og:url" content="https://monodyle.github.io/blog/sql-database-hacking"/><meta property="og:type" content="website"/><meta property="og:title" content="Mấy cái trò Database Hacking"/><meta property="og:description" content="Hôm nọ mình vừa đọc được một bài write-up của một bạn White-hat sau khi báo cáo lại lỗ hổng trên trang web của Đại học Harvard, tự dưng thấy kỹ năng về bảo mật của mình bao lâu nay... kém ghê"/><meta property="og:image" content="https://monodyle.github.io/blog/sql-database-hacking/featured.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="Monody Le"/><meta name="twitter:title" content="Mấy cái trò Database Hacking"/><meta name="twitter:description" content="Hôm nọ mình vừa đọc được một bài write-up của một bạn White-hat sau khi báo cáo lại lỗ hổng trên trang web của Đại học Harvard, tự dưng thấy kỹ năng về bảo mật của mình bao lâu nay... kém ghê"/><meta name="twitter:image" content="https://monodyle.github.io/blog/sql-database-hacking/featured.jpg"/><meta name="next-head-count" content="25"/><link rel="preload" href="/_next/static/css/ba532866a37d159cf218.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ba532866a37d159cf218.css"/><link rel="preload" href="/_next/static/chunks/main-7268da2420ae7ee3cbc5.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-488dc228921f1fdbc0e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.8e39f187f5de284a7e93.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.9233c5a7222f426c41fb.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-ab6a323af59c0bc98c4c.js" as="script"/><link rel="preload" href="/_next/static/chunks/05d954cf.8590707d2bd7065d9eb0.js" as="script"/><link rel="preload" href="/_next/static/chunks/fb55e402fbac2b3f5997de739cc6df0392f34ac4.229205e32f8ecc5ab44d.js" as="script"/><link rel="preload" href="/_next/static/chunks/41f796a5e8ce6b39df87ff7f9eb9b372344dabf5.982a310c5cbd36e9003b.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/sql-database-hacking-8f553adc6f76183b6701.js" as="script"/></head><body><div id="__next"><div class="w-full text-black bg-white"><header class="w-full"><div class="container pt-16"><a class="flex items-center mb-2" href="/"><img src="/favicon-32x32.png" alt="logo"/><strong class="pl-2 font-mono">The Monody&#x27;s Blog</strong></a><nav class="hidden tablet:block"><div class="flex items-center font-mono"><div><a href="/"><span class="text-black">Home</span></a><span class="px-4">/</span></div><div><a href="/about"><span class="text-black">About</span></a><span class="px-4">/</span></div><div><a href="https://ko-fi.com/monodyle" target="_blank"><span class="text-black">☕ Buy me a coffee</span></a></div></div></nav></div></header><main class="pb-16"><div class="container"><div class="mt-8" style="opacity:0;transform:translateY(100px) translateZ(0)"><article><h1 class="mb-10 text-3xl">Mấy cái trò Database Hacking</h1><div class="mb-10 bg-light-gray desktop:-mx-24"><img src="/blog/sql-database-hacking/featured.jpg" alt="Mấy cái trò Database Hacking" title="Mấy cái trò Database Hacking"/></div><div class="flex justify-between"><time class="block mb-10 font-mono text-black">Mar 15, 2020</time><div class="flex justify-end tag-group"><span class="mr-4 font-mono font-medium text-black tag">dev</span><span class="mr-4 font-mono font-medium text-black tag">web</span><span class="mr-4 font-mono font-medium text-black tag">database</span><span class="mr-4 font-mono font-medium text-black tag">hacking</span><span class="mr-4 font-mono font-medium text-black tag">security</span></div></div><div id="content"><p>Hôm nọ mình vừa đọc được một bài write-up của một bạn white-hat sau khi báo cáo lại lỗ hổng SQL Injection trên trang web của Đại học Harvard, tự dưng thấy kỹ năng về bảo mật của mình bao lâu nay... kém ghê.</p><p>Bản thân là sinh viên chuyên ngành <strong>Hệ Thống Thông Tin</strong>, tức là chuyên ngồi đấu vật với mấy cái cơ sở dữ liệu mà lại rất hay quên đi những cái quan trọng như thế này... Cảm thấy xấu hổ, thế là mình phải mò lại những gì mình đã học, nhưng không dùng tới lại quên mất, rồi viết thành một blog để coi như vừa học lại, vừa chia sẻ kiến thức cho mọi người :smug: <del>Mình thật tuyệt</del></p><h2><span id="thằng-chó-mày-hack-web-bố-mày" class="absolute invisible block pt-8 -mt-8"></span><a href="#thằng-chó-mày-hack-web-bố-mày">Thằng chó, mày hack web bố mày...</a><svg width="16" height="24" stroke-width="1.5"><use xlink:href="/assets/icons.svg#link"></use></svg></h2><p>Hè vừa rồi mình có trò chuyện với một ông anh trong nghề, ổng tâm sự về chuyện bị thằng nào thả bot nó clean mẹ cái database, để lại đúng một dòng duy nhất:</p><blockquote><p>Gửi bố mày vài Bitcoin đê, bố mày trả lại dữ liệu cho... :lookdown:</p></blockquote><p>Và kèm theo đó là địa chỉ ví bitcoin của hắn :surrender: Tính ông anh mình được cái thật thà, nhà cũng không có gì ngoài điều kiện, thế là gửi cho nó vài bitcoin coi như tiền ăn sáng, hôm sau thấy nó restore lại dữ liệu thật :mokas:</p><p>Nhưng mà tức quá, ai đời làm lập trình có sản phẩm đang chạy phà phà lại có thằng choá nào hack, nghĩ có cay không cơ chứ? :yikes:</p><p>Mình không rõ là cái database đó bị hack như thế nào, nhưng khá chắc chắn phần lớn là bởi vì code chưa đủ bảo mật và có nhiều lỗ hổng. Các hacker sẽ viết một con bot chuyên đi dạo trên mạng để attack vào những case bảo mật thường dễ bị hack nhất.</p><p>Vì vậy bài viết này mình sẽ giới thiệu cho các bạn một loại lỗ hổng <strong>cơ bản</strong> nhưng cực kỳ nguy hiểm, giải thích cơ chế và hướng dẫn cách phòng chống. Và xin giới thiệu cái trò gọi là <strong>SQL Injection</strong>.</p><div class="note" emoji="1"><strong>Lưu ý:</strong><p>Bài viết này nhằm mục đích giao lưu kỹ năng bảo mật lập trình, không cổ suý các bạn đi phá làng phá xóm. Hãy tỉnh táo :smug:</p></div><h2><span id="nhập-môn-hack-cơ-sở-dữ-liệu-sql" class="absolute invisible block pt-8 -mt-8"></span><a href="#nhập-môn-hack-cơ-sở-dữ-liệu-sql">Nhập môn hack Cơ sở dữ liệu SQL</a><svg width="16" height="24" stroke-width="1.5"><use xlink:href="/assets/icons.svg#link"></use></svg></h2><p>Trong nhiều loại tấn công lỗ hổng nhằm vào website, tấn công <strong>SQL Injection</strong> là một trong những loại nguy hiểm và phổ biến nhất. Nó đã từng gây ra nhiều thiệt hại đáng kể cho nhiều doanh nghiệp và tổ chức trong rất nhiều năm, và đương nhiên sẽ còn tiếp diễn trong tương lai.</p><figure class="flex flex-col items-center max-w-full my-10 tablet:my-12 desktop:my-16"><img alt="SQL Injection là gì??" data-src="/blog/sql-database-hacking/draw-01.jpg" class="lazyload"/><figcaption class="px-2 mt-4 text-xs tracking-wide text-center tablet:text-sm desktop:text-base">SQL Injection là gì??</figcaption></figure><p>Theo <a href="https://vi.wikipedia.org/wiki/SQL_injection" target="_blank" rel="noopener noreferrer" class="no-underline text-primary">Wikipedia</a> :popcorn::</p><blockquote><p><strong>SQL injection</strong> là một kỹ thuật cho phép những kẻ tấn công lợi dụng lỗ hổng của việc kiểm tra dữ liệu đầu vào trong các ứng dụng web và các thông báo lỗi của hệ quản trị cơ sở dữ liệu trả về để <em>inject</em> (<em>tiêm vào</em>) và thi hành các câu lệnh SQL <u>bất hợp pháp</u>.</p></blockquote><p>Ờ thì khái niệm như vậy đấy, hiểu một cách đơn giản tức là loại tấn công này nhằm vào các <strong>input</strong> có <strong>tương tác trực tiếp</strong> với <strong>database</strong> ở <strong>back-end</strong> (ví dụ như các input email, password ở form login). Thông thường, attacker sẽ tấn công để ăn cắp dữ liệu, loại này về cơ bản là hiền nhất, sau đó tới xáo trộn dữ liệu để cản trở sự hoạt động của website, và trường hợp xấu nhất, là quyền truy cập quản trị vào máy chủ database bị chiếm. :moka:</p><p>Trong lịch sử, đã có rất nhiều đợt tấn công SQL Injection nhằm mục đích:</p><ul><li>Trích xuất thông tin nhạy cảm, ví dụ như về an sinh xã hội, hay thông tin thẻ tín dụng</li><li>Trích xuất thông tin người dùng đã được đăng ký trên các website, ở Việt Nam cũng không ít trường hợp</li><li>Xoá luôn cái database, có rất nhiều trang web không sử dụng backup dữ liệu, và khi bị xoá thì coi như cả hệ thống tê liệt, ví dụ của ông anh bên trên là ví dụ gần gũi nhất</li><li>Tiêm mã độc thực thi vào trang web khi người dùng truy cập</li></ul><p><strong>Nhắc lại một lần nữa:</strong> Tấn công về SQL Injection cực kỳ phổ biến. Các công ty lớn như <strong>Yahoo</strong> hay <strong>Sony</strong> đã từng là nhạn nhân của trò chơi này. Các nhóm hacker còn viết hẳn các script bot để tự đi tấn công dạo trên internet, vì vậy hãy luôn cẩn thận với sản phẩm của bạn.</p><h3><span id="cơ-chế-khai-thác-và-tấn-công" class="absolute invisible block pt-8 -mt-8"></span><a href="#cơ-chế-khai-thác-và-tấn-công">Cơ chế khai thác và tấn công</a><svg width="16" height="24" stroke-width="1.5"><use xlink:href="/assets/icons.svg#link"></use></svg></h3><p>SQL Injection tấn công bằng cách gửi một mã lệnh SQL độc đến back-end của máy chủ cơ sở đữ liệu, thông qua các request của người dùng mà website cho phép. Bất kỳ input nào cũng có thể được sử dụng để gửi mã độc, tức là bao gồm cả: các thẻ <code>&lt;input&gt;</code> nhập liệu, query strings, cookies và file upload.</p><p>Mình sẽ có một ví dụ như sau: Giả sử đây là trang đăng nhập vào ngân hàng <strong>PankHub</strong>, với form đăng nhập gồm 2 fields là <code>email</code> và <code>password</code>:</p><figure class="flex flex-col items-center max-w-full my-10 tablet:my-12 desktop:my-16"><img data-src="/blog/sql-database-hacking/02.jpg" class="lazyload"/></figure><p>Bây giờ mình sẽ thử đăng nhập tài khoản của người dùng tên là <strong>Phát</strong> (jk, don&#x27;t panic) với <em>email</em> là: <code>phat.nhagiau@pankhub.com</code> và <em>password</em> là <code>password</code></p><figure class="flex flex-col items-center max-w-full my-10 tablet:my-12 desktop:my-16"><img data-src="/blog/sql-database-hacking/03.jpg" class="lazyload"/></figure><p>Ừ thì đương nhiên là không đăng nhập được rồi :okay: Đây là trường hợp giả sử mình là một attacker, và mình tình cờ địa được email của người dùng này sau khi đi ngang qua lúc nó đang đăng nhập vào ngân hàng ở tiệm net :smug: Victim của mình là một thằng đại gia nhà giàu, tiền không những được quy ra bằng vàng để trong két mà còn có cả một đống trong nhà băng. Xác định được mục tiêu thì trích xuất thông tin mục tiêu là điều cần thiết. Vì vậy mình chỉ thử đăng nhập cho vui thôi, đương nhiên làm gì có thằng <del>ngu</del> nào đặt mật khẩu là <code>password</code> cơ chứ (jk)</p><p>Bây giờ hãy nhìn vấn đề từ phía server log nhé, chúng ta sẽ có 1 cái logging như sau:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4">Rendering login page.
Checking supplied authentication details for phat.nhagiau@pankhub.com.
Finding user in database.
No such user, report this to the user (invalid credentials?).
Rendering login page.
</code></div></pre><p>Sau đó, mình tiếp tục truy thử login vào tài khoản của victim, nhưng lần này password mình sẽ thêm một <em>dấu nháy đơn</em> <code>&#x27;</code>, kết quả có được là:</p><figure class="flex flex-col items-center max-w-full my-10 tablet:my-12 desktop:my-16"><img data-src="/blog/sql-database-hacking/04.jpg" class="lazyload"/></figure><p>Thấy sự khác biệt rồi phải không? Thông thường, với những trường hợp sai thông tin đăng nhập sẽ luôn cho ra một message lỗi (trang nào nó random message thì bó tay), vì vậy có gì đó không đúng xảy ra rồi, có thể nguyên do là bởi dấu nháy đơn chăng?</p><p>Server log:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4">...

Rendering login page.
Checking supplied authentication details for phat.nhagiau@pankhub.com.
Finding user in database.
An error occurred: PG::SyntaxError: ERROR: unterminated quoted string at or near &quot;&#x27;password&#x27;&#x27; limit 1&quot; LINE 1: ...ers where email = &#x27;phat.nhagiau@pankhub.com&#x27; and password = &#x27;password&#x27;... ^ : select * from users where email = &#x27;phat.nhagiau@pankhub.com&#x27; and password = &#x27;password&#x27;&#x27; limit 1.
Unable to login this user due to unexpected error.
Rendering login page.
</code></div></pre><p>Nhìn thấy ở log hiển thị SQL syntax error chứ? Điều này chứng tỏ dấu nháy đơn chính là nguyên nhân gây ra lỗi. Thử ghép vào câu lệnh SQL được chạy trên server thì nó sẽ trông như thế này:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#D73A49">SELECT</span><span style="color:#000000"> </span><span style="color:#D73A49">*</span>
<span style="color:#000000">  </span><span style="color:#D73A49">FROM</span><span style="color:#000000"> users</span>
<span style="color:#000000"> </span><span style="color:#D73A49">WHERE</span><span style="color:#000000"> email </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#22863A">&#x27;phat.nhagiau@pankhub.com&#x27;</span>
<span style="color:#000000">   </span><span style="color:#D73A49">AND</span><span style="color:#000000"> pass  </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#22863A">&#x27;password&#x27;&#x27; LIMIT 1</span>
</code></div></pre><p>Dư 1 dấu nháy đơn, câu lệnh này chạy trong SQL chắc chắn sẽ lỗi. Và đây chính là thứ gọi là <strong>SQL Injection</strong>.</p><p>Sau khi xác định được lỗ hổng, mình sẽ thử đăng nhập lại với password là <strong><code>&#x27; OR 1=1--</code></strong>. Câu lệnh SQL lúc này được thực thi trên server sẽ là:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#D73A49">SELECT</span><span style="color:#000000"> </span><span style="color:#D73A49">*</span>
<span style="color:#000000">  </span><span style="color:#D73A49">FROM</span><span style="color:#000000"> users</span>
<span style="color:#000000"> </span><span style="color:#D73A49">WHERE</span><span style="color:#000000"> email </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#22863A">&#x27;phat.nhagiau@pankhub.com&#x27;</span>
<span style="color:#000000">   </span><span style="color:#D73A49">AND</span><span style="color:#000000"> pass  </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#22863A">&#x27;&#x27;</span><span style="color:#000000"> </span><span style="color:#D73A49">OR</span><span style="color:#000000"> </span><span style="color:#005CC5">1</span><span style="color:#D73A49">=</span><span style="color:#005CC5">1</span><span style="color:#000000"> </span><span style="color:#6A737D">--&#x27; LIMIT 1</span>
</code></div></pre><p>Server log:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4">Rendering login page.
Checking supplied authentication details for phat.nhagiau@pankhub.com.
Finding user in database.
Authentication details confirmed, establishing session for this user.
</code></div></pre><figure class="flex flex-col items-center max-w-full my-10 tablet:my-12 desktop:my-16"><img data-src="/blog/sql-database-hacking/05.jpg" class="lazyload"/></figure><p>Xong, tài khoản của bạn nằm trong tay tôi :ok:</p><p>Cơ chế hoạt động đơn giản nhất của <strong>SQL Injection</strong> là như vậy đọ. Thực thi nó không hề khó, nhưng để nhận ra được trang nào có lỗ hổng thì lại khá khó, vì không phải lúc nào khai thác lỗ hổng SQL Injection nó cũng y chang như vậy.</p><h3><span id="nhưng-tại-sao-có-lỗ-hổng-này" class="absolute invisible block pt-8 -mt-8"></span><a href="#nhưng-tại-sao-có-lỗ-hổng-này">Nhưng tại sao có lỗ hổng này?</a><svg width="16" height="24" stroke-width="1.5"><use xlink:href="/assets/icons.svg#link"></use></svg></h3><p>Lý do lớn nhất là các bạn chưa thể tiếp cận toàn bộ các case trong quá trình code. Bạn không bao giờ lường trước được người dùng sẽ làm cái <del>đéo</del> gì trên sản phẩm của mình. :sad: Chính vì vậy thường các case không bao giờ được nghĩ tới này lại vô tình tạo ra lỗ hổng cho attacker khai thác.</p><p>Khi viết các câu lệnh SQL trong source (ở đây mình sẽ lấy <strong>PHP</strong> làm ví dụ), đa số các bạn thường viết kiểu:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#000000">$query = &quot;SELECT * FROM USERS</span>
<span style="color:#000000">  WHERE email = &#x27;&quot; . $_POST[&#x27;email&#x27;] . &quot;&#x27;</span>
<span style="color:#000000">  AND password = &#x27;&quot; . $_POST[&#x27;password&#x27;] . &quot;&#x27;</span>
<span style="color:#000000">  LIMIT 1;&quot;</span>
<span style="color:#000000">$result = $connection-&gt;query($sql);</span>
</code></div></pre><p>Khi người dùng gửi request đăng nhập có thông tin, thì câu query trên sẽ tương đương với:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#D73A49">SELECT</span><span style="color:#000000"> </span><span style="color:#D73A49">*</span>
<span style="color:#000000">  </span><span style="color:#D73A49">FROM</span><span style="color:#000000"> USERS</span>
<span style="color:#000000"> </span><span style="color:#D73A49">WHERE</span><span style="color:#000000"> email </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#22863A">&#x27;phat.nhagiau@pankhub.com&#x27;</span>
<span style="color:#000000">   </span><span style="color:#D73A49">AND</span><span style="color:#000000"> password </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#22863A">&#x27;password&#x27;</span><span style="color:#000000"> </span><span style="color:#D73A49">LIMIT</span><span style="color:#000000"> </span><span style="color:#005CC5">1</span>
</code></div></pre><p>Tức là cái gì gửi lên, thì param tương đương sẽ được thay thế bằng cái đó. Điều này vô tình tạo ra một lỗ hổng cực kỳ nguy hiểm. Nếu bạn từng học các môn liên quan tới database hoặc làm việc với database nhiều, các bạn có thể hiểu rằng chỉ với những câu lệnh SQL thôi cũng đủ để chúng làm bất cứ thứ gì liên quan tới dữ liệu.</p><p>Không những thế, SQL Injection còn có thể thực thi được mã HTML hoặc PHP trong nhiều trường hợp. Đó là lý do tại sao lỗ hổng này nghiêm trọng như vậy.</p><h3><span id="chống-injection-như-thế-nào" class="absolute invisible block pt-8 -mt-8"></span><a href="#chống-injection-như-thế-nào">Chống injection như thế nào?</a><svg width="16" height="24" stroke-width="1.5"><use xlink:href="/assets/icons.svg#link"></use></svg></h3><h4 id="truy-vấn-tham-số-parameterized-statements">Truy vấn tham số (Parameterized Statements)</h4><p>Đa số các ngôn ngữ lập trình hỗ trợ truy vấn SQL đều sẽ hỗ trợ chạy các câu lệnh SQL bằng cách tạo truy vấn để trích xuất các tham số khi cần thiết. Các câu lệnh nên được <em>tham số hoá</em> để đảm bảo rằng các <em>tham số</em> (tức là <em>dữ liệu đầu vào</em>) đưa vào câu lệnh SQL được xử lý một cách an toàn nhất.</p><p>Với ví dụ ở <a href="#nh%c6%b0ng-t%e1%ba%a1i-sao-c%c3%b3-l%e1%bb%97-h%e1%bb%95ng-n%c3%a0y" target="_blank" rel="noopener noreferrer" class="no-underline text-primary">phần trên</a>, chúng ta sẽ thử đưa nó về dạng truy vấn tham số:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#000000">// Câu lệnh SQL chờ tham số</span>
<span style="color:#000000">$sql = &quot;SELECT * FROM USERS</span>
<span style="color:#000000">  WHERE email = ?</span>
<span style="color:#000000">  AND password = ?</span>
<span style="color:#000000">  LIMIT 1&quot;;</span>
<!-- -->
<span style="color:#000000">// Chuẩn bị và ràng buộc</span>
<span style="color:#000000">$stmt = $connection-&gt;prepare($sql);</span>
<span style="color:#000000">$stmt-&gt;bind_param(&quot;ss&quot;, $email, $password);</span>
<!-- -->
<span style="color:#000000">// Truyền tham số và thực thi</span>
<span style="color:#000000">$email = $_POST[&#x27;email&#x27;];</span>
<span style="color:#000000">$password = $_POST[&#x27;password&#x27;];</span>
<span style="color:#000000">$stmt-&gt;execute();</span>
<!-- -->
<span style="color:#000000">// Đừng quên close connection mỗi lần thực thi xong</span>
<span style="color:#000000">$stmt-&gt;close();</span>
<span style="color:#000000">$conn-&gt;close();</span>
</code></div></pre><p>Dạng <strong>bind</strong> param này chắc có lẽ sẽ khó để truyền tham số khi số lượng column cần dùng trong query trở nên nhiều hơn, vậy nên còn có cách như sau:</p><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#000000">// Câu lệnh SQL chờ tham số</span>
<span style="color:#000000">$sql = &quot;SELECT * FROM USERS</span>
<span style="color:#000000">  WHERE email = :email</span>
<span style="color:#000000">  AND password = :password</span>
<span style="color:#000000">  LIMIT 1&quot;;</span>
<!-- -->
<span style="color:#000000">// Chuẩn bị và ràng buộc</span>
<span style="color:#000000">$stmt = $connection-&gt;prepare($sql);</span>
<span style="color:#000000">$stmt-&gt;bindParam(&quot;:email&quot;, $email);</span>
<span style="color:#000000">$stmt-&gt;bindParam(&quot;:password&quot;, $password);</span>
<!-- -->
<span style="color:#000000">// Truyền tham số và thực thi</span>
<span style="color:#000000">$email = $_POST[&#x27;email&#x27;];</span>
<span style="color:#000000">$password = $_POST[&#x27;password&#x27;];</span>
<span style="color:#000000">$stmt-&gt;execute();</span>
</code></div></pre><p>Ví dụ trong một số ngôn ngữ khác:</p><strong>C#</strong><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#6A737D">// Create the SQL command.</span>
<span style="color:#D73A49">SqlCommand</span><span style="color:#000000"> command </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#D73A49">new</span><span style="color:#000000"> </span><span style="color:#D73A49">SqlCommand</span><span style="color:#000000">(</span><span style="color:#22863A">&quot;select * from users where email = @email&quot;</span><span style="color:#000000">, conn);</span>
<!-- -->
<span style="color:#6A737D">// Add the parameter values in separately.</span>
<span style="color:#000000">command.Parameters.</span><span style="color:#6F42C1">Add</span><span style="color:#000000">(</span><span style="color:#D73A49">new</span><span style="color:#000000"> </span><span style="color:#D73A49">SqlParameter</span><span style="color:#000000">(</span><span style="color:#22863A">&quot;email&quot;</span><span style="color:#000000">, email);</span>
<!-- -->
<span style="color:#6F42C1">using</span><span style="color:#000000"> (SqlDataReader reader </span><span style="color:#D73A49">=</span><span style="color:#000000"> command.</span><span style="color:#6F42C1">ExecuteReader</span><span style="color:#000000">())</span>
<span style="color:#000000">{</span>
<span style="color:#000000">  </span><span style="color:#6F42C1">while</span><span style="color:#000000"> (reader.</span><span style="color:#6F42C1">Read</span><span style="color:#000000">())</span>
<span style="color:#000000">  {</span>
<span style="color:#000000">    </span><span style="color:#6A737D">// Do something with the retrieved data.</span>
<span style="color:#000000">  }</span>
<span style="color:#000000">}</span>
</code></div></pre><strong>Django</strong><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#6A737D"># Good</span>
<span style="color:#000000">Users.objects.</span><span style="color:#6F42C1">filter(email</span><span style="color:#D73A49">=</span><span style="color:#6F42C1">email)</span>
<!-- -->
<span style="color:#6A737D"># Good</span>
<span style="color:#000000">Users.objects.</span><span style="color:#6F42C1">raw(</span><span style="color:#22863A">&quot;select * from users where email = %s&quot;</span><span style="color:#6F42C1">, [email])</span>
<!-- -->
<span style="color:#6A737D"># Liable to got hacked</span>
<span style="color:#000000">Users.objects.</span><span style="color:#6F42C1">raw(</span><span style="color:#22863A">&quot;select * from users where email = &#x27;%s&#x27;&quot;</span><span style="color:#6F42C1"> </span><span style="color:#D73A49">%</span><span style="color:#6F42C1"> email)</span>
</code></div></pre><strong>Node</strong><pre><div class="mb-10 mt-4 pb-4 overflow-x-auto border border-mid-gray rounded-sm pt-4"><code class="block float-left min-w-full px-4"><span style="color:#6A737D">// node-sql</span>
<span style="color:#D73A49">var</span><span style="color:#000000"> sql </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#005CC5">require</span><span style="color:#000000">(</span><span style="color:#22863A">&#x27;sql&#x27;</span><span style="color:#000000">);</span>
<span style="color:#D73A49">var</span><span style="color:#000000"> query </span><span style="color:#D73A49">=</span><span style="color:#000000"> user.</span><span style="color:#005CC5">select</span><span style="color:#000000">(user.</span><span style="color:#6F42C1">star</span><span style="color:#000000">()))</span>
<span style="color:#000000">                .</span><span style="color:#6F42C1">from</span><span style="color:#000000">(user)</span>
<span style="color:#000000">                .</span><span style="color:#6F42C1">where</span><span style="color:#000000">(user.email.</span><span style="color:#6F42C1">equals</span><span style="color:#000000">(email)).</span><span style="color:#6F42C1">toQuery</span><span style="color:#000000">();</span>
<!-- -->
<span style="color:#6A737D">// mysql</span>
<span style="color:#D73A49">var</span><span style="color:#000000"> mysql </span><span style="color:#D73A49">=</span><span style="color:#000000"> </span><span style="color:#005CC5">require</span><span style="color:#000000">(</span><span style="color:#22863A">&#x27;mysql&#x27;</span><span style="color:#000000">);</span>
<span style="color:#D73A49">var</span><span style="color:#000000"> connection </span><span style="color:#D73A49">=</span><span style="color:#000000"> mysql.</span><span style="color:#6F42C1">createConnection</span><span style="color:#000000">({ host</span><span style="color:#D73A49">:</span><span style="color:#000000"> HOST, user</span><span style="color:#D73A49">:</span><span style="color:#000000"> USERNAME, password</span><span style="color:#D73A49">:</span><span style="color:#000000"> PASSWORD });</span>
<span style="color:#000000">connection.</span><span style="color:#6F42C1">connect</span><span style="color:#000000">();</span>
<!-- -->
<span style="color:#000000">connection.</span><span style="color:#6F42C1">query</span><span style="color:#000000">(</span>
<span style="color:#000000">  </span><span style="color:#22863A">&#x27;select * from users where email = ?&#x27;</span><span style="color:#000000">,</span>
<span style="color:#000000">  [email],</span>
<span style="color:#000000">  </span><span style="color:#D73A49">function</span><span style="color:#000000">(err, rows, fields) {</span>
<span style="color:#000000">    </span><span style="color:#6A737D">// Do something with the retrieved data.</span>
<span style="color:#000000">  });</span>
<!-- -->
<span style="color:#000000">connection.</span><span style="color:#6F42C1">end</span><span style="color:#000000">();</span>
</code></div></pre><h4 id="hãy-validation-từ-front-end-cho-tới-back-end">Hãy validation từ Front-end cho tới Back-end</h4><p><strong>Validation</strong> dữ liệu chưa bao giờ là công việc thú vị :okay: tuy nhiên việc validation 2 bước giúp bảo mật tốt hơn, và đồng thời cũng tránh được các lỗi lặt vặt không cần thiết.</p><p>Ví dụ trên front-end các field nhập vào dữ liệu số, nên dùng input <code>number</code> thay vì input <code>text</code>. Các field bắt buộc thì nên <code>required</code>. Mặc dù trên front-end có thể verify dữ liệu đầu vào, nhưng attacker vẫn có thể ignore những rule này để trực tiếp gửi dữ liệu vào back-end, vậy nên trên back-end chúng ta nên verify lại dữ liệu, như kiểu <code>$age = (int)$_POST[&#x27;age&#x27;]</code>. Điều này sẽ tránh được các yếu tố gây ra lỗi không đáng có.</p><h4 id="phân-quyền-quản-trị">Phân quyền quản trị</h4><p>Mình thấy rất nhiều bạn khi xây dựng project, thường sử dụng tài khoản <strong><code>root</code></strong> của DBMS để làm tất cả mọi thứ... Đó là một sai lầm cực kỳ lớn. Phần lớn các bạn đều chưa hiểu mức độ nghiêm trọng của vấn đề này, vấn đề này giải thích cũng khó hiểu, phải trong trường hợp thực tế các bạn học được thì dễ nhớ hơn.</p><p>Tuy nhiên mình vẫn sẽ đưa ra một ví dụ đơn giản như sau:</p><p>Khi bạn đăng nhập, việc cần làm của database chỉ là vào đọc dữ liệu (quyền <strong>READ</strong>) để verify thông tin. Trong khi các bạn lại cấp full quyền cho <strong>user</strong> của DBMS chỉ dùng để đọc... Giả sử form đăng nhập trên hệ thống có lỗ hổng SQL Injection, thì việc attack từ cái form login xoá toàn bộ dữ liệu của bạn là điều cực kỳ đơn giản, còn nếu user tương tác với database chỉ có quyền đọc, thì attacker cũng chỉ có thể truy cập tài khoản đó mà thôi.</p><p>Nghĩa là bạn chỉ gặp một nguy cơ nhỏ hơn so với cái nguy cơ cực kỳ khủng khiếp kia.</p><p>Đó, không phải tự dưng mà <strong>Oracle</strong> được cho là hệ quản trị database SQL bảo mật nhất, lý do là vì phân quyền của <strong>Oracle</strong> cực kỳ chặt chẽ. Do đó, tốt nhất nên phân quyền cho các user trong DBMS một cách chặt chẽ và hợp lý, để tránh hối hận về lâu về dài.</p><p>Vấn đề phân quyền không phải chỉ ở trong DBMS, mà còn ở trong cả hệ thống, và cấu hình <strong>server</strong>. Nhắc lại lần nữa: <strong>Phân quyền cực kỳ quan trọng</strong></p><figure class="flex flex-col items-center max-w-full my-10 tablet:my-12 desktop:my-16"><img alt="chmod 777 and you will see" data-src="/blog/sql-database-hacking/06.jpg" class="lazyload"/><figcaption class="px-2 mt-4 text-xs tracking-wide text-center tablet:text-sm desktop:text-base">chmod 777 and you will see</figcaption></figure><h2><span id="kết-luận" class="absolute invisible block pt-8 -mt-8"></span><a href="#kết-luận">Kết luận</a><svg width="16" height="24" stroke-width="1.5"><use xlink:href="/assets/icons.svg#link"></use></svg></h2><p>SQL Injection không phải một vấn đề mới mẻ, nó tồn tại cả một thập kỷ rồi nhưng nó vẫn đứng đầu bảng xếp hạng về các lỗ hổng nguy hiểm nhất trong nhiều năm liền. Chỉ với một vài bước dễ dàng, hệ thống của bạn có thể bị tê liệt hoàn toàn... Chống thì khó, mà phá thì dễ lắm.</p><p>Nên nhớ:</p><blockquote><p>Đạo cao một thước, ma cao một trượng.</p></blockquote></div></article></div></div></main><nav class="w-full h-16 bg-white border-t border-mid-gray select-none fixed bottom-0 left-0 tablet:hidden"><div class="flex justify-between w-full max-w-sm px-2 mx-auto"><a href="/"><div class="flex flex-col items-center justify-center w-16 h-16 relative text-black"><h5 class="mt-1 text-xs font-medium tracking-wide">Home</h5></div></a><a href="/about"><div class="flex flex-col items-center justify-center w-16 h-16 relative text-black"><h5 class="mt-1 text-xs font-medium tracking-wide">About</h5></div></a><a href="https://ko-fi.com/monodyle" target="_blank"><div class="flex flex-col items-center justify-center w-16 h-16 relative text-black"><h5 class="mt-1 text-xs font-medium tracking-wide">☕ Buy me a coffee</h5></div></a></div></nav></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/sql-database-hacking","query":{},"buildId":"x9WJkXvd179KAEIzP7gse","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-08c52e9b0920dbad6282.js"></script><script src="/_next/static/chunks/main-7268da2420ae7ee3cbc5.js" async=""></script><script src="/_next/static/chunks/webpack-488dc228921f1fdbc0e7.js" async=""></script><script src="/_next/static/chunks/framework.8e39f187f5de284a7e93.js" async=""></script><script src="/_next/static/chunks/commons.9233c5a7222f426c41fb.js" async=""></script><script src="/_next/static/chunks/pages/_app-ab6a323af59c0bc98c4c.js" async=""></script><script src="/_next/static/chunks/05d954cf.8590707d2bd7065d9eb0.js" async=""></script><script src="/_next/static/chunks/fb55e402fbac2b3f5997de739cc6df0392f34ac4.229205e32f8ecc5ab44d.js" async=""></script><script src="/_next/static/chunks/41f796a5e8ce6b39df87ff7f9eb9b372344dabf5.982a310c5cbd36e9003b.js" async=""></script><script src="/_next/static/chunks/pages/blog/sql-database-hacking-8f553adc6f76183b6701.js" async=""></script><script src="/_next/static/x9WJkXvd179KAEIzP7gse/_buildManifest.js" async=""></script><script src="/_next/static/x9WJkXvd179KAEIzP7gse/_ssgManifest.js" async=""></script></body></html>